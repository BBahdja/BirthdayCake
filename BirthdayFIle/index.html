<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Happy Birthday! ðŸŽ‚</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Comic Sans MS', cursive, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: white;
      text-align: center;
    }

    .title {
      font-size: 3em;
      margin-bottom: 60px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.3); }
      to   { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.5); }
    }

    /* Cake */
    .cake-container { position: relative; margin: 20px 0; width: 90%; max-width: 300px; }
    .cake { 
      width: 100%; 
      aspect-ratio: 3 / 2; 
      background: linear-gradient(to bottom, #8B4513, #A0522D); 
      border-radius: 10% 10% 5% 5%; 
      position: relative; 
      box-shadow: 0 10px 20px rgba(0,0,0,0.3); 
      margin: 0 auto; 
    }
    .cake-layer { 
      width: 90%; 
      height: 15%; 
      background: linear-gradient(to bottom, #D2691E, #CD853F); 
      border-radius: 15px; 
      position: absolute; 
      top: -10%; 
      left: 5%; 
      box-shadow: 0 5px 10px rgba(0,0,0,0.2); 
    }
    .cake-layer-2 {
      width: 85%;
      height: 12%;
      background: linear-gradient(to bottom, #F4A460, #DEB887);
      border-radius: 12px;
      position: absolute;
      top: -18%;
      left: 7.5%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .frosting { 
      position: absolute; 
      top: -10px; 
      left: 0; 
      right: 0; 
      height: 20px; 
      background: linear-gradient(to bottom, #fff, #f8f8f8); 
      border-radius: 50px; 
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); 
    }
    .frosting-2 {
      position: absolute;
      top: -8px;
      left: 0;
      right: 0;
      height: 16px;
      background: linear-gradient(to bottom, #ffe4e1, #ffd6cc);
      border-radius: 40px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Candles: grid 2 rows of 6 (6 per row) */
    .candles-container {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      grid-template-columns: repeat(6, auto);
      grid-gap: 15px 20px;
      justify-content: center;
    }

    .candle { width: 6px; height: 35px; background: linear-gradient(to bottom, #4ecdc4, #44a08d); border-radius: 4px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .flame { width: 10px; height: 14px; background: radial-gradient(circle, #ffeb3b 20%, #ff5722 70%); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; position: absolute; top: -14px; left: -2px; animation: flicker 1.5s ease-in-out infinite alternate; transition: opacity 0.3s ease; }
    .flame.blown-out { opacity: 0; }

    @keyframes flicker {
      0% { transform: rotate(-2deg) scale(1); } 100% { transform: rotate(2deg) scale(1.1); }
    }

    .controls { margin: 20px 0; display:flex; gap:15px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .blow-button {
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      border: none; color: white; padding: 12px 20px; font-size: 16px; border-radius: 50px;
      cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; font-family: inherit;
    }
    .blow-button:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(0,0,0,0.3); }
    .blow-button:active { transform: translateY(0); }

    .instructions { margin: 20px 0; font-size: 16px; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; max-width: 420px; }
    .status { font-size: 18px; margin: 10px 0; font-weight: bold; min-height: 24px; }
    .success-message { font-size: 24px; color: #ffeb3b; margin: 20px 0; animation: bounce 1s ease infinite; display: none; }

    @keyframes bounce {
      0%,20%,50%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); }
    }

    .confetti { position: absolute; width: 10px; height: 10px; background: #ff6b6b; animation: fall 3s linear infinite; }
    @keyframes fall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

    .volume-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 8px 12px;
      border-radius: 999px;
      margin-top: 10px;
    }

    .volume-bar {
      width: 100px;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    .volume-fill {
      height: 100%;
      background: linear-gradient(to right, #4ecdc4, #ff6b6b);
      width: 0%;
      transition: width 0.1s ease;
    }

    @media (max-width: 500px) {
      .title { font-size: 2em; margin-bottom: 40px; }
      .candle { width: 5px; height: 28px; }
      .flame { width: 8px; height: 12px; }
    }
  </style>
</head>
<body>
  <div class="title">ðŸŽ‰ Happy Birthday Raanu! ðŸŽ‰</div>

  <div class="cake-container">
    <div class="cake">
      <div class="cake-layer"><div class="frosting"></div></div>
      <div class="cake-layer-2"><div class="frosting-2"></div></div>
      <div class="candles-container" id="candlesContainer"></div>
    </div>
  </div>

  <div class="instructions">
    Click "Start Microphone", wait for calibration (1s), then blow gently into your microphone to extinguish the candles! Make a wish! âœ¨
  </div>

  <div class="controls">
    <button class="blow-button" onclick="startMicrophone()" id="micButton">ðŸŽ¤ Start Microphone</button>
    <button class="blow-button" onclick="resetCandles()">ðŸ”¥ Relight Candles</button>
  </div>

  <div class="volume-indicator" id="volumeIndicator" style="display: none;">
    <span>ðŸŽ¤ Volume:</span>
    <div class="volume-bar">
      <div class="volume-fill" id="volumeFill"></div>
    </div>
  </div>

  <div class="status" id="status">Ready to blow out candles!</div>
  <div class="success-message" id="successMessage">ðŸŽŠ All candles blown out! Happy Birthday! ðŸŽŠ</div>

  <script>
    let audioContext = null;
    let microphone = null;
    let analyser = null;
    let dataArrayTime = null;
    let isListening = false;
    let isCalibrated = false;
    let baselineRMS = 0;
    let sensitivity = 10.0; // Maximum sensitivity (easiest setting)
    const minAbsoluteThreshold = 0.015; // Lower base threshold
    let threshold = minAbsoluteThreshold;
    let smoothedRMS = 0;
    let blowFrameCount = 0;
    const requiredFrames = 2; // Reduce required frames for easier triggering
    const blowCooldownMs = 400; // Reduce cooldown
    let lastBlowTime = 0;

    let candles = [];
    let blownOutCandles = new Set();

    function createCandles() {
      const container = document.getElementById('candlesContainer');
      container.innerHTML = '';
      candles = [];
      blownOutCandles.clear();
      for (let i = 0; i < 12; i++) {
        const candle = document.createElement('div');
        candle.className = 'candle';
        candle.innerHTML = '<div class="flame" id="flame' + i + '"></div>';
        container.appendChild(candle);
        candles.push(candle);
      }
      document.getElementById('status').textContent = 'Ready to blow out candles!';
      document.getElementById('successMessage').style.display = 'none';
    }

    function computeRMS() {
      analyser.getByteTimeDomainData(dataArrayTime);
      let sum = 0;
      for (let i = 0; i < dataArrayTime.length; i++) {
        const n = (dataArrayTime[i] - 128) / 128;
        sum += n * n;
      }
      return Math.sqrt(sum / dataArrayTime.length);
    }

    function updateThreshold() {
      // Fixed sensitivity calculation - higher sensitivity = lower threshold (easier to trigger)
      const sensitivityFactor = Math.pow(2, (10 - sensitivity) / 2); // Inverted scale
      threshold = Math.max(baselineRMS * sensitivityFactor + 0.01, minAbsoluteThreshold);
      
      if (isCalibrated) {
        document.getElementById('status').textContent = 'Ready to blow! ðŸ’¨';
      }
    }

    function calibrateAmbient(durationMs = 800) { // Faster calibration
      return new Promise((resolve) => {
        const start = performance.now();
        let frames = 0;
        let sum = 0;

        function step() {
          const rms = computeRMS();
          sum += rms;
          frames++;
          if (performance.now() - start < durationMs) {
            requestAnimationFrame(step);
          } else {
            baselineRMS = sum / Math.max(frames, 1);
            isCalibrated = true;
            updateThreshold();
            resolve();
          }
        }
        requestAnimationFrame(step);
      });
    }

    async function startMicrophone() {
      const button = document.getElementById('micButton');
      const status = document.getElementById('status');

      if (!isListening) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          microphone = audioContext.createMediaStreamSource(stream);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 1024; // Smaller for better performance
          dataArrayTime = new Uint8Array(analyser.fftSize);
          microphone.connect(analyser);

          isListening = true;
          isCalibrated = false;
          baselineRMS = 0;
          smoothedRMS = 0;
          blowFrameCount = 0;

          button.textContent = 'ðŸŽ¤ Listening... (Click to stop)';
          button.onclick = stopMicrophone;
          document.getElementById('volumeIndicator').style.display = 'flex';

          status.textContent = 'Calibrating ambient noise â€” stay quiet for a moment...';
          await calibrateAmbient(800);
          await new Promise(r => setTimeout(r, 100));
          updateThreshold();
          detectBlow();
        } catch (err) {
          console.error('Microphone error', err);
          status.textContent = 'Microphone access denied or error. Please allow microphone and try again.';
        }
      }
    }

    function stopMicrophone() {
      if (isListening) {
        isListening = false;
        if (audioContext) {
          audioContext.close();
          audioContext = null;
          analyser = null;
          microphone = null;
          dataArrayTime = null;
        }
        const button = document.getElementById('micButton');
        const status = document.getElementById('status');
        button.textContent = 'ðŸŽ¤ Start Microphone';
        button.onclick = startMicrophone;
        status.textContent = 'Microphone stopped. Click Start Microphone to try again.';
        document.getElementById('volumeIndicator').style.display = 'none';
      }
    }

    function detectBlow() {
      if (!isListening || !analyser) return;
      
      const rms = computeRMS();
      smoothedRMS = smoothedRMS * 0.7 + rms * 0.3; // More responsive smoothing
      
      // Update volume indicator
      const volumePercent = Math.min(100, (smoothedRMS / (threshold * 2)) * 100);
      document.getElementById('volumeFill').style.width = volumePercent + '%';
      
      if (smoothedRMS > threshold && (Date.now() - lastBlowTime) > blowCooldownMs) {
        blowFrameCount++;
      } else {
        blowFrameCount = Math.max(0, blowFrameCount - 1);
      }
      
      if (blowFrameCount >= requiredFrames && (Date.now() - lastBlowTime) > blowCooldownMs) {
        blowOutRandomCandle();
        lastBlowTime = Date.now();
        blowFrameCount = 0;
      }
      
      requestAnimationFrame(detectBlow);
    }

    function blowOutRandomCandle() {
      const available = [];
      for (let i = 0; i < candles.length; i++) if (!blownOutCandles.has(i)) available.push(i);
      if (available.length === 0) return;
      
      const idx = available[Math.floor(Math.random() * available.length)];
      const flame = document.getElementById('flame' + idx);
      if (flame) flame.classList.add('blown-out');
      blownOutCandles.add(idx);
      
      const remaining = candles.length - blownOutCandles.size;
      if (remaining === 0) {
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('status').textContent = 'ðŸŽ‰ All candles blown out â€” Happy Birthday! ðŸŽ‰';
        createConfetti();
        setTimeout(stopMicrophone, 1000); // Stop after celebration
      } else {
        document.getElementById('status').textContent = `Great! ${remaining} candles remaining!`;
      }
    }

    function resetCandles() {
      blownOutCandles.clear();
      for (let i = 0; i < candles.length; i++) {
        const flame = document.getElementById('flame' + i);
        if (flame) flame.classList.remove('blown-out');
      }
      document.getElementById('successMessage').style.display = 'none';
      if (isCalibrated) {
        updateThreshold();
      } else {
        document.getElementById('status').textContent = 'All candles relit! Ready to blow them out again!';
      }
    }

    function createConfetti() {
      const colors = ['#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#ffeaa7','#dda0dd'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 2 + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 80);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      createCandles();
    });
  </script>
</body>
</html>
